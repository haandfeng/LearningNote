# 系统设计之UUID

---

设计一个系统, 提供不同的uuid, 需要保证未来100年不同的id, 一定要求每个都不一样
1) 要求在原理上就不出现重复, 所以不能只用hash实现
2) 使用者很多, 极其频繁, 巨大的吞吐量


设想:


### ip/mac/hostname + 时间
  同一纳秒收到5万个uuid请求呢?
  ip拼, 要保证所有机器ip不一样: 当一个机器宕机, 重新上线机器有这个ip
所有机器时间要统一: 强同步问题

如何确保所有机器时间上完全的同步?
  如果同步总是有纳秒误差, 怎么处理?
  
###  有这么一种设计

利用垂直扩展的技巧

![[Pasted image 20201214150515.png]]

全球真正给出所有不同 ID 的机器一台, 
这一台机器，它可能有多台从机保证它永远在工作, 而且这个同步很好做

这台机器上只维持两个变量的数据: 
- **只记一个Base: 当前数字编号给到多少号了** base/start = 17万亿
     他就一个变量, 非常好同步
- 下一级的服务器: 国家级
    - 中国服务器, 当他要给所有的用户提供 UID 的时候，它会像顶部服务器要数据: 
       告诉我**现在数字给我的最小值**, 比如告诉现在的最小值是17万亿
       给出**一个range**, 比如 500亿
       最大值: 17万亿+500亿
       服务器的base就变为17万亿+500亿
       这样一来我中国向服务器要的频度唯一可以控制, 你如果要的很频繁, 就把range调大, 比如你一分钟要一次, 我把range搞成5000亿, 搞成50 万亿，让你一天给我沟通一次
       就是**把压力这件事情化成range**
    - 中国服务器只保留两个数据, 他自己的base 和 range
       中国服务器往下, 省级服务器, 县级服务器...
       我每一台机器像上要的过程都是请求的数据都是**最小值加一个range**
       也就是说**所有压力都被 range 化解掉了**
好处:
   任何一台服务器挂了他不用维持任何数据，在他上线的时候，向他上级要新的 UUID 就行了。
   宕机的时候像上级服务器要编号就行, 不要跨级别搞, 每个级别range都是调好的, 跨级会造成过于频繁的沟通

```text
全世界 有一台皇帝机器
 不要求这台机器有多少

下面份中国, 美国, 英国
再往下 分 省, 州
再往下街道, 社区
返回response:
start, range

不用管同步问题
新上机器, 临时可以向父机要新的id

皇帝机挂了, 只要同步机器记住他的start就行, 往外极低的调用频率

这是垂直扩展

太频繁, 就增大range
机器挂了, 新上机器现场要 上级申请新的 base + range
```

怎么数字无限制?
用string实现大整数

  